# Prompt

@flake.nix @home/modules/themes/catppuccin/default.nix @home/modules/window-manager/rofi/default.nix │
│ @home/modules/window-manager/rofi/theme.rasi @home/modules/window-manager/hyprland.nix │
│ @home/modules/window-manager/hyprpanel/workstation.json @home/modules/settings/nerd-fonts.nix Take a look at my nixos system config. How │
│ can i make a theme switcher or make it simple to switch themes throughout my system without requireing a rebuild? something that wont create │
│ a bunch of files that need to be manaully deleted when rebuilding (if they are in the way of nix symplinked files they will prevent the │
│ rebuild from executing). No rebuild is not an absolute requirement but would be nice. if its not possible without breaking rebuilds then │
│ dont bother. Help me architect a solution / plan for theme switching

# Detailed Plan: Nix-Powered Theme Switcher

This document outlines the architecture and implementation of a hybrid theme switching system for your NixOS environment.

## 1. Core Architecture

The system is composed of three main parts:

1.  **Theme Definitions (`definitions.nix`):** A central Nix file where all themes and their associated assets (colors, packages, config files) are defined. This is the single source of truth.
2.  **Nix Installer Module (`installer.nix`):** A Home Manager module that reads the definitions and ensures all necessary theme packages and configuration files are installed and managed by Nix. It places theme assets into a predictable directory (`~/.config/nix-themes/`).
3.  **Theme Switcher Script (`theme-switcher.nix`):** A script, generated by Nix, that can be run from the command line to change the active theme instantly without a rebuild. It works by manipulating symlinks and calling theme-related utilities.

This architecture separates the _installation_ of themes (a rebuild-worthy event) from the _activation_ of a theme (a runtime event).

## 2. File Structure

Here are the new and modified files in this plan.

**New Files:**

- `THEME_SWITCHER_PLAN.md` (This file)
- `home/modules/themes/definitions.nix`: Where you'll define your themes.
- `home/modules/themes/installer.nix`: The Nix module to install themes.
- `home/modules/themes/theme-switcher.nix`: The Nix expression that generates the switcher script.
- `home/modules/themes/rofi/catppuccin-macchiato.rasi`: Example Rofi theme file.
- `home/modules/themes/hyprland/catppuccin-macchiato.conf`: Example Hyprland theme file.
- `home/modules/themes/hyprpanel/catppuccin-macchiato.jsonc`: Example Hyprpanel theme file (using JSONC for comments).

**Modified Files:**

- `users/henhal/home.nix`: To import the new theme installer module.
- `home/modules/themes/catppuccin/default.nix`: Will be mostly removed or repurposed.
- `home/modules/window-manager/hyprland.nix`: To source the dynamic theme file.
- `home/modules/window-manager/rofi/default.nix`: To import the dynamic theme file.
- `home/modules/window-manager/hyprpanel/default.nix`: To use a dynamic theme file.

## 3. Implementation Steps

### Step 1: Define the Themes

First, we'll create the central definition file. For this example, we'll start with your existing `catppuccin-macchiato` theme.

**File: `home/modules/themes/definitions.nix`**

```nix
# /home/henhal/.dotfiles/home/modules/themes/definitions.nix
{ pkgs }: {
  "catppuccin-macchiato" = {
    # For user-facing menus
    name = "Catppuccin (Macchiato)";

    # GTK & Qt Theming
    gtk = {
      package = pkgs.catppuccin-gtk.override { variant = "macchiato"; accents = [ "mauve" ]; size = "compact"; };
      name = "catppuccin-macchiato-mauve-compact";
    };
    kvantum = {
      package = pkgs.catppuccin-kvantum.override { variant = "macchiato"; accent = "mauve"; };
      name = "catppuccin-macchiato-mauve";
    };
    icons = {
      package = pkgs.papirus-icon-theme;
      name = "Papirus-Dark";
    };
    cursor = {
      package = pkgs.bibata-cursors;
      name = "Bibata-Modern-Classic";
      size = 24;
    };

    # Application-specific theme files
    # These paths are relative to this file
    rofi.themeFile = ./rofi/catppuccin-macchiato.rasi;
    hyprland.themeFile = ./hyprland/catppuccin-macchiato.conf;
    hyprpanel.themeFile = ./hyprpanel/catppuccin-macchiato.jsonc;
  };

  # You can add other themes here later, e.g., "dracula"
  # "dracula" = { ... };
}
```

### Step 2: Create Theme Snippets

We need to extract the theme-specific parts of your configs into separate files.

**File: `home/modules/themes/hyprland/catppuccin-macchiato.conf`**

```ini
# Hyprland colors for Catppuccin Macchiato
general {
    col.active_border = rgba(cba6f7ff) rgba(f38ba8ff) 45deg
    col.inactive_border = rgba(18192600)
}

decoration {
    shadow_color = rgba(00000055)
}
```

**File: `home/modules/themes/rofi/catppuccin-macchiato.rasi`**

```css
/* Rasi colors for Catppuccin Macchiato */
* {
  background: #24273a;
  background-alt: #1e2030;
  foreground: #cad3f5;
  selected: #cba6f7; /* Mauve */
  active: #89dceb; /* Sky */
  urgent: #f38ba8; /* Flamingo */
}
```

**File: `home/modules/themes/hyprpanel/catppuccin-macchiato.jsonc`**
(Using JSONC format to allow comments for clarity)

```jsonc
// Hyprpanel theme for Catppuccin Macchiato
// This file will be converted to pure JSON by Nix.
{
  "theme": {
    "bar": {
      "transparent": true,
    },
    "font": {
      "name": "Hack Nerd Font",
      "size": "12px",
    },
    // We can add more specific color overrides here if hyprpanel supports it
    // and if it doesn't pick them up from the GTK theme automatically.
    // For now, we'll assume it inherits well.
  },
}
```

### Step 3: Create the Nix Installer Module

This module installs everything needed for all themes.

**File: `home/modules/themes/installer.nix`**

```nix
# /home/henhal/.dotfiles/home/modules/themes/installer.nix
{ config, pkgs, lib, ... }:

let
  # Import all theme definitions
  themes = import ./definitions.nix { inherit pkgs; };
  themeNames = builtins.attrNames themes;
  themeList = builtins.attrValues themes;

  # Helper to convert JSONC to JSON
  jsoncToJSON = path: pkgs.runCommand "jsonc-to-json" {} ''
    ${pkgs.nodePackages.jsonc-parser}/bin/jsonc-parser --strip-comments ${path} > $out
  '';

in
{
  imports = [
    ./theme-switcher.nix # Import the script generator
  ];

  # 1. Install all packages from all themes
  home.packages = lib.unique (lib.flatten (
    (map (t: [ t.gtk.package t.kvantum.package t.icons.package t.cursor.package ]) themeList)
  ));

  # 2. Create a JSON file mapping theme names to their properties for the script
  home.xdg.configFile."nix-themes/themes.json".text = builtins.toJSON (
    lib.mapAttrs (name: theme: {
      gtkTheme = theme.gtk.name;
      iconTheme = theme.icons.name;
      cursorTheme = theme.cursor.name;
      kvantumTheme = theme.kvantum.name;
    }) themes
  );

  # 3. Write all theme config snippets to ~/.config/nix-themes/
  home.xdg.configFile = lib.foldl' (acc: name: acc // {
    "nix-themes/${name}/hyprland.conf".source = themes.${name}.hyprland.themeFile;
    "nix-themes/${name}/rofi.rasi".source = themes.${name}.rofi.themeFile;
    "nix-themes/${name}/hyprpanel.json".source = jsoncToJSON themes.${name}.hyprpanel.themeFile;
  }) {} themeNames;

  # 4. Set a default theme on first build (optional, but good practice)
  # This part replaces your old catppuccin/default.nix
  qt = {
    enable = true;
    platformTheme.name = "gtk";
    style.name = "kvantum";
  };

  gtk = {
    enable = true;
    theme.name = themes."catppuccin-macchiato".gtk.name;
    iconTheme.name = themes."catppuccin-macchiato".icons.name;
    gtk3.extraConfig = { "gtk-application-prefer-dark-theme" = "1"; };
    gtk4.extraConfig = { "gtk-application-prefer-dark-theme" = "1"; };
  };

  dconf.settings = { "org/gnome/desktop/interface".color-scheme = "prefer-dark"; };

  home.pointerCursor = {
    gtk.enable = true;
    x11.enable = true;
    name = themes."catppuccin-macchiato".cursor.name;
    size = themes."catppuccin-macchiato".cursor.size;
    package = themes."catppuccin-macchiato".cursor.package;
  };
}
```

### Step 4: Create the Theme Switcher Script

This Nix file generates a shell script and adds it to your path.

**File: `home/modules/themes/theme-switcher.nix`**

```nix
# /home/henhal/.dotfiles/home/modules/themes/theme-switcher.nix
{ config, pkgs, ... }:

let
  # This script will be placed in ~/.local/bin/theme-switch
  script = pkgs.writeShellScriptBin "theme-switch" '''
    #!/usr/bin/env bash
    set -e

    THEME_DIR="$HOME/.config/nix-themes"
    THEME_MAP="$THEME_DIR/themes.json"

    # --- Helper Functions ---
    print_usage() {
      echo "Usage: theme-switch <theme_name>"
      echo "Available themes:"
      jq -r 'keys[]' "$THEME_MAP" | sed 's/^/  - /'
    }

    # --- Main Logic ---
    if [[ -z "$1" ]]; then
      echo "Error: No theme name provided."
      print_usage
      exit 1
    fi

    THEME_NAME="$1"

    if ! jq -e --arg name "$THEME_NAME" '_[$name]' "$THEME_MAP" > /dev/null; then
      echo "Error: Theme '$THEME_NAME' not found."
      print_usage
      exit 1
    fi

    echo "Switching to theme: $THEME_NAME"

    # --- Application Switching ---

    # 1. GTK, Icons, Cursors
    echo "Applying GTK, Icon, and Cursor themes..."
    GTK_THEME=$(jq -r --arg name "$THEME_NAME" '_[$name].gtkTheme' "$THEME_MAP")
    ICON_THEME=$(jq -r --arg name "$THEME_NAME" '_[$name].iconTheme' "$THEME_MAP")
    CURSOR_THEME=$(jq -r --arg name "$THEME_NAME" '_[$name].cursorTheme' "$THEME_MAP")
    gsettings set org.gnome.desktop.interface gtk-theme "$GTK_THEME"
    gsettings set org.gnome.desktop.interface icon-theme "$ICON_THEME"
    gsettings set org.gnome.desktop.interface cursor-theme "$CURSOR_THEME"

    # 2. Kvantum
    echo "Applying Kvantum theme..."
    KVANTUM_THEME=$(jq -r --arg name "$THEME_NAME" '_[$name].kvantumTheme' "$THEME_MAP")
    kvantummanager --set "$KVANTUM_THEME"

    # 3. Hyprland
    echo "Applying Hyprland theme..."
    ln -sf "$THEME_DIR/$THEME_NAME/hyprland.conf" "$HOME/.config/hypr/theme.conf"
    hyprctl reload

    # 4. Rofi
    echo "Applying Rofi theme..."
    ln -sf "$THEME_DIR/$THEME_NAME/rofi.rasi" "$HOME/.config/rofi/theme.rasi"

    # 5. Hyprpanel
    # This assumes hyprpanel watches its config file for changes.
    # If not, we may need to restart it via systemctl.
    echo "Applying Hyprpanel theme..."
    ln -sf "$THEME_DIR/$THEME_NAME/hyprpanel.json" "$HOME/.config/hyprpanel/theme.json"
    # Example of restarting if needed:
    # systemctl --user restart hyprpanel.service

    echo "Theme '$THEME_NAME' applied successfully!"
  ''';
in
{
  # Add jq for the script and add the script to the path
  home.packages = [ pkgs.jq script ];
}
```

### Step 5: Update Application Configurations

Now, we modify the main application configs to use these dynamic theme files.

**File: `home/modules/window-manager/hyprland.nix` (Modification)**

Find the `extraConfig` section at the bottom and add the `source` line. Also, remove the hardcoded border colors from the `general` section.

```nix
# ... existing hyprland config ...
      general = {
        # ...
        # "col.active_border" = "rgb(98971A) rgb(CC241D) 45deg"; # REMOVE THIS
        # "col.inactive_border" = "0x00000000"; # REMOVE THIS
        # ...
      };
# ...
    extraConfig = ''
      # ... other env vars ...

      # Source the dynamic theme file
      source = ~/.config/hypr/theme.conf
    '';
# ...
```

**File: `home/modules/window-manager/rofi/default.nix` (Modification)**

Change the `home.file` definition to create a `config.rasi` that imports our dynamic theme, and remove the hardcoded theme from the file content.

```nix
# /home/henhal/.dotfiles/home/modules/window-manager/rofi/default.nix
{ config, pkgs, userSettings, ... }: {
  home.packages = with pkgs; [ rofi-wayland ];

  home.file.".config/rofi/config.rasi".text = ''
    /*****----- Configuration -----*****/
    configuration {
    	modi:                       "drun,run,filebrowser,window";
        show-icons:                 true;
        display-drun:               "APPS";
        display-run:                "RUN";
        display-filebrowser:        "FILES";
        display-window:             "WINDOW";
    	drun-display-format:        "{name}";
    	window-format:              "{w} · {c} · {t}";
    }

    /* Import the dynamic theme file */
    @import "theme.rasi"

    /*****----- Main Window -----*****/
    window {
        /* properties for window widget */
        transparency:                "real";
        location:                    center;
        anchor:                      center;
        fullscreen:                  false;
        width:                       1000px;
        x-offset:                    0px;
        y-offset:                    0px;

        /* properties for all widgets */
        enabled:                     true;
        border-radius:               15px;
        cursor:                      "default";
        background-color:            @background;
    }
    /* ... Paste the rest of your generic rofi config here ... */
    /* ... Ensure you remove the hardcoded * colors section ... */
  '';

  # This ensures the symlink target for the theme exists on first launch
  home.file.".config/rofi/theme.rasi".source = ./../themes/rofi/catppuccin-macchiato.rasi;
}
```

**File: `home/modules/window-manager/hyprpanel/default.nix` (Modification)**

The mechanism for loading the `hyprpanel` configuration needs to be updated to point to our dynamic theme file. This will likely involve changing the systemd service that starts it.

```nix
# In home/modules/window-manager/hyprpanel/default.nix
# ...
# We need to find where hyprpanel is started and change its config path.
# Assuming a systemd service like this:
systemd.user.services.hyprpanel = {
  Unit.Description = "Hyprland Panel";
  Install.WantedBy = [ "hyprland-session.target" ];
  Service = {
    # Change the config path to our dynamic theme file
    ExecStart = "${pkgs.hyprpanel}/bin/hyprpanel -c ~/.config/hyprpanel/theme.json";
  };
};

# Ensure the symlink target exists on first launch
home.file.".config/hyprpanel/theme.json".source = ./../themes/hyprpanel/catppuccin-macchiato.jsonc;
```

### Step 6: Final Assembly

Finally, tie it all together.

**File: `users/henhal/home.nix` (Modification)**

```nix
# ...
imports = [
  # ... your other imports
  ../home/modules/themes/installer.nix
];
# ...
```

We will also **delete** `home/modules/themes/catppuccin/default.nix` as its logic has been moved into `home/modules/themes/installer.nix`.

## 4. Usage

1.  Run `nixos-rebuild switch` one time to build and install all the new files and themes.
2.  From then on, you can simply run `theme-switch <theme-name>` in your terminal. For example: `theme-switch catppuccin-macchiato`.
3.  To add a new theme, you only need to:
    a. Add its definition to `definitions.nix`.
    b. Add its theme snippet files (for rofi, hyprland, etc.).
    c. Run `nixos-rebuild switch` once to install it.
    d. It will then be available to the `theme-switch` script.
